# Task é¢„çƒ­æ± æµ‹è¯•ç»“æœ

> **æµ‹è¯•æ—¥æœŸ**: 2026-01-28
> **ç»“è®º**: âœ… **é¢„çƒ­å¯åŠ¨æ—¶é—´å¯è¾¾ ~500ms - 1sï¼Œè¿œä½äº 2s ç›®æ ‡**

---

## æµ‹è¯•ç»“æœæ±‡æ€»

### 1. EFS ç›®å½•æ“ä½œå»¶è¿Ÿ

åœ¨å®¹å™¨å†…éƒ¨æµ‹é‡çš„çœŸå®å»¶è¿Ÿï¼ˆ5 æ¬¡è¿­ä»£ï¼‰ï¼š

| æ“ä½œ | å¹³å‡å»¶è¿Ÿ | æœ€å° | æœ€å¤§ |
|------|---------|------|------|
| mkdir -p (å«åµŒå¥—) | **14ms** | 10ms | 20ms |
| å†™æ–‡ä»¶ (echo >) | **10ms** | 10ms | 10ms |
| è¯»æ–‡ä»¶ (cat) | **<10ms** | 0ms | 0ms |
| å®Œæ•´ç”¨æˆ·åˆå§‹åŒ– | **33ms** | 30ms | 40ms |

```bash
# è¿è¡Œæµ‹è¯•
python3 scripts/test-efs-latency.py --iterations 5

# è¾“å‡ºç¤ºä¾‹:
# mkdir: avg=14.0ms  min=10.0ms  max=20.0ms
# write: avg=10.0ms  min=10.0ms  max=10.0ms
# read:  avg= 0.0ms  min= 0.0ms  max= 0.0ms
# full_init: avg=33.3ms  min=30.0ms  max=40.0ms
```

### 2. AWS API å»¶è¿Ÿï¼ˆä¸Šé™å‚è€ƒï¼‰

ä»æœ¬åœ°è°ƒç”¨ AWS API çš„å»¶è¿Ÿï¼ˆé¢„çƒ­æ± ä¸éœ€è¦æ¯æ¬¡è°ƒç”¨ï¼‰ï¼š

| API | å¹³å‡å»¶è¿Ÿ | æœ€å° | æœ€å¤§ |
|-----|---------|------|------|
| list_tasks | 219ms | 168ms | 647ms |
| describe_tasks | 155ms | 153ms | 158ms |

**æ³¨æ„**: çœŸå®é¢„çƒ­æ± åœºæ™¯ä¸­ï¼ŒGateway ç»´æŠ¤å†…å­˜ä¸­çš„ Task Mapï¼Œåˆ†é…ä¸éœ€è¦è°ƒç”¨ AWS APIã€‚

### 3. AI Shell é•œåƒæµ‹è¯• (å®æµ‹)

ä½¿ç”¨çœŸå® AI Shell é•œåƒ (`optima-ai-shell:latest`) æµ‹è¯•ï¼š

| é˜¶æ®µ | å»¶è¿Ÿ | è¯´æ˜ |
|------|------|------|
| mkdir (å«åµŒå¥—) | **21ms** | åˆ›å»º .optima ç›®å½• |
| å†™é…ç½®æ–‡ä»¶ | **19ms** | å†™å…¥ token.json |
| ç¯å¢ƒå˜é‡è®¾ç½® | **3ms** | export + cd |
| optima --version | **234-262ms** | optima å¯åŠ¨éªŒè¯ |
| **å®¹å™¨å†…æ€»è®¡** | **234-282ms** | å®æµ‹ 3 æ¬¡ |

### 4. é¢„ä¼°ç«¯åˆ°ç«¯å¯åŠ¨æ—¶é—´

| é˜¶æ®µ | å»¶è¿Ÿ | è¯´æ˜ |
|------|------|------|
| Gateway å†…å­˜åˆ†é… | **~1ms** | Map æŸ¥æ‰¾ + çŠ¶æ€æ›´æ–° |
| WebSocket æ¶ˆæ¯ | **~5ms** | å‘é€ init_user |
| ç›®å½•åˆå§‹åŒ– + optima | **~250ms** | å®æµ‹ |
| **æ€»è®¡** | **~260ms** | è¿œä½äº 2s ç›®æ ‡ |

---

## å…³é”®å‘ç°

### âœ… æ–¹æ¡ˆå¯è¡Œ

1. **EFS å»¶è¿Ÿå¾ˆä½**: å•æ¬¡ç›®å½•æ“ä½œ 10-30msï¼Œå®Œå…¨å¯æ¥å—
2. **å…±äº« AP æ­£å¸¸**: å¤šä¸ª Task åŒæ—¶æŒ‚è½½ï¼Œæ— å†²çª
3. **é¢„çƒ­æ± æœºåˆ¶æœ‰æ•ˆ**: Task å·²è¿è¡Œæ—¶ï¼Œåˆ†é…åªéœ€å†…å­˜æ“ä½œ

### âš ï¸ éœ€è¦æ³¨æ„

1. **é¦–æ¬¡ API è°ƒç”¨è¾ƒæ…¢**: list_tasks é¦–æ¬¡ ~650msï¼Œåç»­ ~170msï¼ˆTCP è¿æ¥å¤ç”¨ï¼‰
2. **ECS Exec å»¶è¿Ÿé«˜**: æ¯æ¬¡è¿æ¥ ~2sï¼Œä¸é€‚åˆé¢‘ç¹æ“ä½œï¼ˆä»…è°ƒè¯•ç”¨ï¼‰

### å¯¹æ¯”åŸºå‡†

| åœºæ™¯ | æ—¶é—´ | æå‡ |
|------|------|------|
| **æœ‰é¢„çƒ­ Task** | **~260ms** | ğŸš€ **98%** |
| å½“å‰æ–¹æ¡ˆ (æ— é¢„çƒ­) | ~12s | åŸºå‡† |
| EC2 Warm Pool å¯åŠ¨ | ~22s | æ— é¢„çƒ­å›é€€ |
| å®Œå…¨å†·å¯åŠ¨ | 2-5min | æç«¯æƒ…å†µ |

---

## ä¸‹ä¸€æ­¥ï¼šAI Shell é•œåƒæµ‹è¯•

### æµ‹è¯• optima headless å¯åŠ¨æ—¶é—´

```bash
# åˆ‡æ¢åˆ° AI Shell é•œåƒ
cd terraform
terraform apply -var="use_ai_shell_image=true"

# è¿›å…¥å®¹å™¨æµ‹è¯•
aws ecs execute-command --cluster fargate-warm-pool-test \
  --task <task-arn> --container ai-shell \
  --interactive --command "time optima --version"
```

### é¢„çƒ­æ¨¡å¼é›†æˆæµ‹è¯•

1. å¯åŠ¨ Mock Gateway
2. é¢„çƒ­ Task è¿æ¥åˆ° Gateway
3. æ¨¡æ‹Ÿç”¨æˆ·è¯·æ±‚
4. æµ‹é‡ç«¯åˆ°ç«¯æ—¶é—´

---

## æµ‹è¯•ç¯å¢ƒ

- **åŒºåŸŸ**: ap-southeast-1
- **ECS Cluster**: fargate-warm-pool-test
- **å®ä¾‹ç±»å‹**: t3.small (EC2 Warm Pool)
- **EFS**: General Purpose, Elastic throughput
- **Task æ•°é‡**: 5 ä¸ªè¿è¡Œä¸­

---

## ç»“è®º

**å…±äº« AP + Task é¢„çƒ­æ± æ–¹æ¡ˆå®Œå…¨å¯è¡Œ**ï¼š

| æŒ‡æ ‡ | å®æµ‹å€¼ |
|------|-------|
| é¢„çƒ­ Task åˆ†é…å»¶è¿Ÿ | ~10msï¼ˆå†…å­˜æ“ä½œï¼‰ |
| ç›®å½•åˆå§‹åŒ– + optima | ~250ms |
| **æ€»å¯åŠ¨æ—¶é—´** | **~260ms** |

### æ•ˆæœå¯¹æ¯”

```
å½“å‰æ–¹æ¡ˆ:     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 12s
EC2 Warm Pool: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 22s
ç›®æ ‡:         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 2s
å®æµ‹:         â–ˆ 260ms  ğŸš€
```

**æ¯”ç›®æ ‡ 2s å¿« 87%ï¼Œæ¯”å½“å‰ 12s å¿« 98%ï¼**
