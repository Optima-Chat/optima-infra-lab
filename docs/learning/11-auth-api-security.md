# 11 - è®¤è¯ä¸ API å®‰å…¨

> ä» JWT åˆ°é›¶ä¿¡ä»»ï¼šä½ çš„æ¯ä¸€ä¸ª API è¯·æ±‚éƒ½åº”è¯¥è¢«è´¨ç–‘

---

## æˆ‘ä»¬ç°åœ¨åœ¨å“ª

```
Optima å¹³å°çš„è®¤è¯ç°çŠ¶ï¼š

âœ… åšå¾—å¥½çš„:
  - user-auth æœåŠ¡ç»Ÿä¸€å¤„ç† JWT ç­¾å‘ä¸éªŒè¯
  - å¯†é’¥ç®¡ç†ç”¨ Infisical + AWS SSMï¼Œä¸åœ¨ä»£ç é‡Œç¡¬ç¼–ç 
  - ALB å±‚é¢ HTTPS ç»ˆæ­¢ï¼ˆACM è¯ä¹¦è‡ªåŠ¨ç»­æœŸï¼‰
  - æ¯ä¸ªæœåŠ¡ç‹¬ç«‹æ•°æ®åº“ç”¨æˆ·ï¼ˆæœ€å°æƒé™éš”ç¦»ï¼‰
  - å®‰å…¨ç»„é™åˆ¶ç½‘ç»œè®¿é—®

âš ï¸ å¯ä»¥æ›´å¥½çš„:
  - JWT åªæœ‰ Access Tokenï¼Œæ²¡æœ‰ Refresh Token æœºåˆ¶
  - Token åŠé”€é çŸ­è¿‡æœŸæ—¶é—´ï¼Œæ— é»‘åå•
  - æœåŠ¡é—´è°ƒç”¨æ²¡æœ‰è®¤è¯ï¼ˆå†…éƒ¨æµé‡=å¯ä¿¡ï¼Ÿï¼‰
  - æ²¡æœ‰ Rate Limitingï¼ˆä¸€ä¸ªæ¶æ„ç”¨æˆ·å¯ä»¥æ— é™è°ƒç”¨ APIï¼‰
  - æ²¡æœ‰ CORS é…ç½®ï¼ˆå‰ç«¯åŸŸåé™åˆ¶ï¼‰
  - æ²¡æœ‰ API ç‰ˆæœ¬ç®¡ç†ç­–ç•¥
  - å¯†é’¥ä¸è‡ªåŠ¨è½®è½¬
```

é—®é¢˜ä¸åªæ˜¯"è®¤è¯èƒ½ç”¨"â€”â€”è€Œæ˜¯ä½ éœ€è¦ç†è§£æ•´ä¸ªè®¤è¯ä½“ç³»çš„è®¾è®¡ç©ºé—´ï¼ŒçŸ¥é“æ¯ä¸€ä¸ªé€‰æ‹©çš„ä»£ä»·å’Œæ”¶ç›Šã€‚

---

## 1. OAuth 2.0 å®Œæ•´æ¡†æ¶

### æ ¸å¿ƒæ€æƒ³

OAuth 2.0 è§£å†³çš„é—®é¢˜ï¼š**å¦‚ä½•è®©ç¬¬ä¸‰æ–¹åº”ç”¨å®‰å…¨åœ°è®¿é—®ç”¨æˆ·èµ„æºï¼Œè€Œä¸éœ€è¦ç”¨æˆ·ç›´æ¥ç»™å‡ºå¯†ç ï¼Ÿ**

```
ä¼ ç»Ÿæ–¹å¼ï¼ˆä¸å®‰å…¨ï¼‰:
  ç”¨æˆ· â†’ "è¿™æ˜¯æˆ‘çš„å¯†ç " â†’ ç¬¬ä¸‰æ–¹åº”ç”¨ â†’ ç”¨å¯†ç è°ƒ API

OAuth 2.0:
  ç”¨æˆ· â†’ "æˆ‘æˆæƒä½ è®¿é—®æˆ‘çš„èµ„æº" â†’ æˆæƒæœåŠ¡å™¨å‘ token â†’ ç¬¬ä¸‰æ–¹ç”¨ token è°ƒ API
```

### å››ç§æˆæƒæµç¨‹

#### Authorization Codeï¼ˆæˆæƒç ï¼Œæœ€å®‰å…¨ï¼‰

```
é€‚ç”¨åœºæ™¯: æœ‰åç«¯æœåŠ¡å™¨çš„ Web åº”ç”¨
å®‰å…¨ç­‰çº§: â˜…â˜…â˜…â˜…â˜…

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·    â”‚     â”‚  å®¢æˆ·ç«¯åº”ç”¨   â”‚     â”‚  æˆæƒæœåŠ¡å™¨    â”‚
â”‚ (æµè§ˆå™¨) â”‚     â”‚  (åç«¯)      â”‚     â”‚ (user-auth)  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                 â”‚                    â”‚
     â”‚  1. ç‚¹å‡»"ç™»å½•"   â”‚                    â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
     â”‚                 â”‚  2. 302 é‡å®šå‘åˆ°æˆæƒé¡µ â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚
     â”‚  3. ç”¨æˆ·è¾“å…¥å‡­è¯å¹¶æˆæƒ                   â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                 â”‚  4. 302 å›è°ƒï¼Œå¸¦ code â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚  5. æµè§ˆå™¨è·Ÿéšé‡å®šå‘                     â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
     â”‚                 â”‚  6. ç”¨ code + secret â”‚
     â”‚                 â”‚     æ¢ tokenï¼ˆåç«¯ï¼‰  â”‚
     â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                 â”‚  7. è¿”å› access_tokenâ”‚
     â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚  8. ç™»å½•æˆåŠŸ     â”‚                    â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚
```

**ä¸ºä»€ä¹ˆå®‰å…¨**: code åªèƒ½ç”¨ä¸€æ¬¡ï¼Œä¸”æ¢ token éœ€è¦ client_secretï¼ˆå­˜åœ¨åç«¯ï¼Œæµè§ˆå™¨æ‹¿ä¸åˆ°ï¼‰ã€‚

#### Authorization Code + PKCEï¼ˆæ¨èç”¨äº SPA å’Œç§»åŠ¨ç«¯ï¼‰

**PKCE (Proof Key for Code Exchange)** è§£å†³äº† SPAï¼ˆå•é¡µåº”ç”¨ï¼‰æ²¡æœ‰åç«¯ã€æ— æ³•å®‰å…¨å­˜å‚¨ client_secret çš„é—®é¢˜ã€‚

```
åŸç†ï¼šç”¨ä¸€æ¬¡æ€§çš„éšæœºæŒ‘æˆ˜ç ä»£æ›¿ client_secret

1. å®¢æˆ·ç«¯ç”Ÿæˆéšæœºå­—ç¬¦ä¸² code_verifier
2. è®¡ç®— code_challenge = SHA256(code_verifier)
3. æˆæƒè¯·æ±‚æ—¶æºå¸¦ code_challenge
4. æ¢ token æ—¶æºå¸¦ code_verifier
5. æœåŠ¡å™¨éªŒè¯ SHA256(code_verifier) === code_challenge
```

```typescript
// PKCE æµç¨‹çš„å®¢æˆ·ç«¯å®ç°
import crypto from 'crypto';

// 1. ç”Ÿæˆ code_verifierï¼ˆ43-128 å­—ç¬¦çš„éšæœºå­—ç¬¦ä¸²ï¼‰
function generateCodeVerifier(): string {
  return crypto.randomBytes(32)
    .toString('base64url')  // URL-safe base64
    .slice(0, 43);
}

// 2. è®¡ç®— code_challenge
function generateCodeChallenge(verifier: string): string {
  return crypto
    .createHash('sha256')
    .update(verifier)
    .digest('base64url');
}

// 3. å‘èµ·æˆæƒè¯·æ±‚
const verifier = generateCodeVerifier();
const challenge = generateCodeChallenge(verifier);

const authUrl = new URL('https://auth.optima.shop/oauth/authorize');
authUrl.searchParams.set('response_type', 'code');
authUrl.searchParams.set('client_id', 'optima-web');
authUrl.searchParams.set('redirect_uri', 'https://app.optima.shop/callback');
authUrl.searchParams.set('code_challenge', challenge);
authUrl.searchParams.set('code_challenge_method', 'S256');
authUrl.searchParams.set('scope', 'openid profile');

// 4. æ¢ token æ—¶å¸¦ä¸Š verifier
const tokenResponse = await fetch('https://auth.optima.shop/oauth/token', {
  method: 'POST',
  headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
  body: new URLSearchParams({
    grant_type: 'authorization_code',
    code: authorizationCode,
    redirect_uri: 'https://app.optima.shop/callback',
    client_id: 'optima-web',
    code_verifier: verifier,  // æœåŠ¡å™¨ä¼šéªŒè¯ SHA256(verifier) === challenge
  }),
});
```

**ä¸ºä»€ä¹ˆ PKCE å®‰å…¨**: å³ä½¿æ”»å‡»è€…æˆªè·äº† authorization codeï¼Œæ²¡æœ‰ code_verifier ä¹Ÿæ— æ³•æ¢å– tokenã€‚

#### Client Credentialsï¼ˆæœºå™¨å¯¹æœºå™¨ï¼‰

```
é€‚ç”¨åœºæ™¯: æœåŠ¡é—´é€šä¿¡ï¼ˆæ²¡æœ‰ç”¨æˆ·å‚ä¸ï¼‰
å®‰å…¨ç­‰çº§: â˜…â˜…â˜…â˜… (å–å†³äº secret ç®¡ç†)

ä¾‹å¦‚: mcp-host è°ƒç”¨ user-auth éªŒè¯ token

POST /oauth/token
Content-Type: application/x-www-form-urlencoded

grant_type=client_credentials
&client_id=mcp-host
&client_secret=ä»Infisicalè·å–
&scope=verify:token user:read
```

**å¯¹åº” Optima åœºæ™¯**: ç›®å‰æœåŠ¡é—´è°ƒç”¨æ²¡æœ‰è®¤è¯ã€‚å¦‚æœè¦åŠ ï¼ŒClient Credentials æ˜¯æœ€åˆé€‚çš„æ–¹å¼ã€‚

#### Implicitï¼ˆéšå¼æˆæƒï¼Œå·²åºŸå¼ƒï¼‰

```
âš ï¸ ä¸è¦ä½¿ç”¨ï¼å·²è¢« OAuth 2.1 åºŸå¼ƒ

åŸå› ï¼štoken ç›´æ¥å‡ºç°åœ¨æµè§ˆå™¨ URL çš„ fragment ä¸­ï¼ˆ#access_token=xxxï¼‰ï¼Œ
å®¹æ˜“è¢«æµè§ˆå™¨å†å²ã€referer å¤´æ³„éœ²ã€‚

æ›¿ä»£æ–¹æ¡ˆï¼šAuthorization Code + PKCE
```

### Refresh Token æœºåˆ¶

Access Token åº”è¯¥çŸ­å¯¿å‘½ï¼ˆ15 åˆ†é’Ÿï¼‰ï¼ŒRefresh Token ç”¨äºæ— æ„Ÿç»­æœŸï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¢æˆ·ç«¯   â”‚           â”‚  æˆæƒæœåŠ¡å™¨    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                        â”‚
     â”‚  è¯·æ±‚èµ„æºï¼ˆaccess_tokenï¼‰  â”‚
     â”‚  â† 401 Token Expired   â”‚
     â”‚                        â”‚
     â”‚  POST /oauth/token      â”‚
     â”‚  grant_type=refresh_tokenâ”‚
     â”‚  refresh_token=xxx      â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                        â”‚  éªŒè¯ refresh_token
     â”‚                        â”‚  ç­¾å‘æ–° access_token
     â”‚  æ–° access_token        â”‚  (å¯é€‰) è½®è½¬ refresh_token
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                        â”‚
     â”‚  é‡è¯•åŸå§‹è¯·æ±‚             â”‚
```

**Refresh Token è½®è½¬ (Rotation)**:

```
æ¯æ¬¡ä½¿ç”¨ refresh_token æ¢æ–° token æ—¶ï¼ŒåŒæ—¶è¿”å›æ–°çš„ refresh_tokenï¼Œ
æ—§çš„ç«‹å³å¤±æ•ˆã€‚

å¥½å¤„ï¼šå³ä½¿ refresh_token è¢«çªƒå–ï¼Œæ”»å‡»è€…åªèƒ½ç”¨ä¸€æ¬¡ï¼Œ
      æ­£å¸¸ç”¨æˆ·ä¸‹æ¬¡åˆ·æ–°æ—¶å‘ç° token å¤±æ•ˆï¼Œç³»ç»Ÿå¯ä»¥è®©æ‰€æœ‰ token å¤±æ•ˆã€‚
```

### Token Introspection

æœåŠ¡ç«¯éªŒè¯ token æœ‰æ•ˆæ€§çš„æ ‡å‡†æ¥å£ï¼ˆRFC 7662ï¼‰ï¼š

```bash
# èµ„æºæœåŠ¡å™¨å‘æˆæƒæœåŠ¡å™¨æŸ¥è¯¢ token çŠ¶æ€
POST /oauth/introspect
Authorization: Basic base64(client_id:client_secret)
Content-Type: application/x-www-form-urlencoded

token=eyJhbGciOiJSUzI1NiIs...

# å“åº”
{
  "active": true,
  "sub": "user-123",
  "scope": "openid profile",
  "client_id": "optima-web",
  "exp": 1700000000
}
```

**JWT vs Introspection çš„æƒè¡¡**:

| æ–¹é¢ | JWT è‡ªéªŒè¯ | Token Introspection |
|------|-----------|-------------------|
| å»¶è¿Ÿ | æ— ç½‘ç»œè°ƒç”¨ï¼Œæœ¬åœ°éªŒè¯ | æ¯æ¬¡è¯·æ±‚è°ƒç”¨æˆæƒæœåŠ¡å™¨ |
| åŠé”€ | å›°éš¾ï¼ˆç­‰è¿‡æœŸï¼‰ | å®æ—¶ç”Ÿæ•ˆ |
| å¯ç”¨æ€§ | æˆæƒæœåŠ¡å™¨å®•æœºä¸å½±å“ | ä¾èµ–æˆæƒæœåŠ¡å™¨ |
| é€‚ç”¨åœºæ™¯ | æœåŠ¡é—´é«˜é¢‘è°ƒç”¨ | éœ€è¦å®æ—¶åŠé”€çš„åœºæ™¯ |

---

## 2. OpenID Connect (OIDC)

### OAuth 2.0 vs OIDC

```
OAuth 2.0: "ä½ è¢«æˆæƒè®¿é—®è¿™äº›èµ„æº"ï¼ˆæˆæƒï¼‰
OIDC:      "ä½ æ˜¯è°"ï¼ˆè®¤è¯ï¼‰+ "ä½ è¢«æˆæƒè®¿é—®è¿™äº›èµ„æº"ï¼ˆæˆæƒï¼‰

OIDC æ˜¯å»ºç«‹åœ¨ OAuth 2.0 ä¹‹ä¸Šçš„èº«ä»½å±‚ï¼š
  OAuth 2.0 + ID Token + UserInfo Endpoint + æ ‡å‡†åŒ– Claims = OIDC
```

### ID Token vs Access Token

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ID Token (ç»™å®¢æˆ·ç«¯çœ‹çš„)                                â”‚
â”‚                                                       â”‚
â”‚ ç›®çš„: å‘Šè¯‰å®¢æˆ·ç«¯"ç”¨æˆ·æ˜¯è°"                              â”‚
â”‚ å—ä¼—: å®¢æˆ·ç«¯åº”ç”¨                                       â”‚
â”‚ å†…å®¹: ç”¨æˆ·èº«ä»½ä¿¡æ¯ï¼ˆåå­—ã€é‚®ç®±ã€å¤´åƒï¼‰                    â”‚
â”‚ ä½¿ç”¨: å®¢æˆ·ç«¯è¯»å–åæ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯ï¼Œä¸å‘ç»™ API                â”‚
â”‚                                                       â”‚
â”‚ {                                                     â”‚
â”‚   "iss": "https://auth.optima.shop",                  â”‚
â”‚   "sub": "user-123",           // ç”¨æˆ·å”¯ä¸€æ ‡è¯†          â”‚
â”‚   "aud": "optima-web",         // é¢å‘ç»™å“ªä¸ªå®¢æˆ·ç«¯      â”‚
â”‚   "exp": 1700000000,                                  â”‚
â”‚   "iat": 1699999000,                                  â”‚
â”‚   "nonce": "abc123",           // é˜²é‡æ”¾               â”‚
â”‚   "name": "å¼ ä¸‰",                                     â”‚
â”‚   "email": "zhang@example.com",                       â”‚
â”‚   "picture": "https://..."                            â”‚
â”‚ }                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Access Token (ç»™ API çœ‹çš„)                             â”‚
â”‚                                                       â”‚
â”‚ ç›®çš„: æˆæƒå®¢æˆ·ç«¯è®¿é—®ç‰¹å®šèµ„æº                              â”‚
â”‚ å—ä¼—: èµ„æºæœåŠ¡å™¨ï¼ˆAPIï¼‰                                  â”‚
â”‚ å†…å®¹: æƒé™èŒƒå›´ï¼Œä¸åº”åŒ…å«æ•æ„Ÿç”¨æˆ·ä¿¡æ¯                       â”‚
â”‚ ä½¿ç”¨: å‘ç»™ APIï¼ŒAPI éªŒè¯åæä¾›æœåŠ¡                       â”‚
â”‚                                                       â”‚
â”‚ {                                                     â”‚
â”‚   "iss": "https://auth.optima.shop",                  â”‚
â”‚   "sub": "user-123",                                  â”‚
â”‚   "aud": "https://api.optima.shop",                   â”‚
â”‚   "scope": "read:products write:orders",              â”‚
â”‚   "exp": 1699999900                                   â”‚
â”‚ }                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¸¸è§é”™è¯¯**: ç”¨ ID Token è°ƒ APIã€‚ID Token çš„ `aud` æ˜¯å®¢æˆ·ç«¯ï¼Œä¸æ˜¯ APIï¼ŒAPI åº”è¯¥æ‹’ç»å®ƒã€‚

### UserInfo Endpoint

```bash
# ç”¨ Access Token è·å–ç”¨æˆ·ä¿¡æ¯
GET /oauth/userinfo
Authorization: Bearer eyJhbGciOiJSUzI1NiIs...

# å“åº”
{
  "sub": "user-123",
  "name": "å¼ ä¸‰",
  "email": "zhang@example.com",
  "email_verified": true,
  "picture": "https://cdn.optima.shop/avatars/user-123.jpg",
  "updated_at": 1699999000
}
```

### æ ‡å‡† Claims

OIDC å®šä¹‰äº†ä¸€ç»„æ ‡å‡†ç”¨æˆ·å±æ€§ï¼ˆClaimsï¼‰ï¼Œé¿å…æ¯ä¸ªç³»ç»Ÿè‡ªå·±å‘æ˜å­—æ®µåï¼š

| Claim | è¯´æ˜ | Scope |
|-------|------|-------|
| `sub` | ç”¨æˆ·å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆå¿…é¡»ï¼‰ | openid |
| `name` | å…¨å | profile |
| `email` | é‚®ç®±åœ°å€ | email |
| `email_verified` | é‚®ç®±æ˜¯å¦å·²éªŒè¯ | email |
| `phone_number` | ç”µè¯å·ç  | phone |
| `address` | åœ°å€ | address |
| `picture` | å¤´åƒ URL | profile |
| `locale` | è¯­è¨€åå¥½ | profile |
| `updated_at` | æœ€åæ›´æ–°æ—¶é—´ | profile |

---

## 3. JWT æ·±å…¥

### JWT ç»“æ„

```
eyJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJ1c2VyLTEyMyJ9.SflKxwRJSM...
  â†‘ Header (Base64)      â†‘ Payload (Base64)       â†‘ Signature

Header:  {"alg": "RS256", "typ": "JWT", "kid": "key-2024-01"}
Payload: {"sub": "user-123", "iss": "auth.optima.shop", "exp": ...}
Signature: RS256(base64(header) + "." + base64(payload), privateKey)
```

**å…³é”®**: JWT æ˜¯ Base64 ç¼–ç çš„ï¼Œä¸æ˜¯åŠ å¯†çš„ã€‚ä»»ä½•äººéƒ½èƒ½è¯»å– payload å†…å®¹ï¼Œç­¾ååªä¿è¯**å®Œæ•´æ€§**ï¼ˆæ²¡è¢«ç¯¡æ”¹ï¼‰ï¼Œä¸ä¿è¯**æœºå¯†æ€§**ã€‚

### ç­¾åç®—æ³•å¯¹æ¯”

| ç®—æ³• | ç±»å‹ | å¯†é’¥ | æ€§èƒ½ | å®‰å…¨æ€§ | æ¨èåœºæ™¯ |
|------|------|------|------|--------|---------|
| **HS256** | å¯¹ç§° | å…±äº«å¯†é’¥ | æœ€å¿« | âš ï¸ | å•æœåŠ¡å†…éƒ¨ |
| **RS256** | éå¯¹ç§° | RSA å…¬/ç§é’¥å¯¹ | è¾ƒæ…¢ | â˜…â˜…â˜…â˜… | å¤šæœåŠ¡éªŒè¯ |
| **ES256** | éå¯¹ç§° | ECDSA å…¬/ç§é’¥å¯¹ | å¿« | â˜…â˜…â˜…â˜…â˜… | ç°ä»£é¦–é€‰ |

```
HS256 (HMAC-SHA256):
  ç­¾å‘å’ŒéªŒè¯ç”¨åŒä¸€ä¸ªå¯†é’¥
  é—®é¢˜: æ¯ä¸ªéœ€è¦éªŒè¯ token çš„æœåŠ¡éƒ½è¦æŒæœ‰å¯†é’¥
        ä¸€ä¸ªæœåŠ¡æ³„éœ²å¯†é’¥ â†’ æ‰€æœ‰æœåŠ¡å—å½±å“

RS256 (RSA-SHA256):
  ç§é’¥ç­¾å‘ï¼Œå…¬é’¥éªŒè¯
  å¥½å¤„: åªæœ‰ user-auth æŒæœ‰ç§é’¥ï¼Œå…¶ä»–æœåŠ¡åªéœ€è¦å…¬é’¥
  ç¼ºç‚¹: RSA ç­¾åè¾ƒæ…¢ï¼Œtoken è¾ƒå¤§ï¼ˆçº¦ 256 å­—èŠ‚ç­¾åï¼‰

ES256 (ECDSA-SHA256):
  ç§é’¥ç­¾å‘ï¼Œå…¬é’¥éªŒè¯
  å¥½å¤„: æ¯” RS256 å¿«ï¼Œç­¾åæ›´å°ï¼ˆçº¦ 64 å­—èŠ‚ï¼‰
  æ¨è: å¦‚æœä»é›¶å¼€å§‹ï¼Œé€‰ ES256
```

**å¯¹ Optima çš„å»ºè®®**: å¦‚æœ user-auth å½“å‰ç”¨ HS256ï¼Œåº”è¯¥è¿ç§»åˆ° RS256 æˆ– ES256ã€‚è¿™æ · mcp-hostã€commerce-backend ç­‰åªéœ€è¦å…¬é’¥å°±èƒ½éªŒè¯ tokenï¼Œä¸éœ€è¦å…±äº«ç§é’¥ã€‚

### Claims è®¾è®¡

```json
// âŒ ä¸å¥½çš„è®¾è®¡ï¼šClaims å¤ªå¤šã€å¤ªæ•æ„Ÿ
{
  "sub": "user-123",
  "name": "å¼ ä¸‰",
  "email": "zhang@example.com",
  "phone": "13800138000",
  "address": "ä¸Šæµ·å¸‚xxxè·¯xxxå·",
  "permissions": ["admin", "write:products", "read:orders", ...],
  "merchant_id": "m-456",
  "plan": "enterprise",
  "payment_method": "credit_card"
}
// é—®é¢˜: token å¤ªå¤§ï¼ˆæ¯ä¸ªè¯·æ±‚éƒ½æºå¸¦ï¼‰ï¼Œä¸”åŒ…å«æ•æ„Ÿä¿¡æ¯

// âœ… å¥½çš„è®¾è®¡ï¼šæœ€å°åŒ– Claims
{
  "sub": "user-123",
  "iss": "https://auth.optima.shop",
  "aud": "https://api.optima.shop",
  "exp": 1700000000,
  "iat": 1699999100,
  "scope": "read write",
  "role": "merchant",
  "merchant_id": "m-456"
}
// éœ€è¦è¯¦ç»†ä¿¡æ¯æ—¶ï¼Œè°ƒ UserInfo Endpoint æˆ–æŸ¥æ•°æ®åº“
```

**Token å¤§å°ä¼˜åŒ–**:
- æ¯ä¸ª JWT Claim éƒ½ä¼šå¢åŠ  token å¤§å°
- token åœ¨æ¯ä¸ª HTTP è¯·æ±‚çš„ Authorization header ä¸­ä¼ è¾“
- Claims è¶Šå°‘è¶Šå¥½ï¼šåªæ”¾**éªŒè¯å’Œæˆæƒ**å¿…éœ€çš„ä¿¡æ¯
- ç”¨æˆ·è¯¦æƒ…èµ° UserInfo Endpointï¼Œä¸æ”¾åœ¨ token é‡Œ

### JWT å¸¸è§å®‰å…¨é™·é˜±

#### é™·é˜± 1: alg=none æ”»å‡»

```json
// æ”»å‡»è€…ç¯¡æ”¹ Header
{"alg": "none", "typ": "JWT"}

// ç„¶åéšæ„ä¿®æ”¹ Payloadï¼Œä¸éœ€è¦ç­¾å
// å¦‚æœæœåŠ¡ç«¯ç›²ç›®ä¿¡ä»» header ä¸­çš„ alg å­—æ®µ...

// âŒ å±é™©çš„éªŒè¯ä»£ç 
function verifyToken(token) {
  const header = decodeHeader(token);
  if (header.alg === 'none') {
    return decodePayload(token);  // ä¸éªŒè¯ç­¾åï¼
  }
  return jwt.verify(token, secret, { algorithms: [header.alg] });
}

// âœ… å®‰å…¨çš„éªŒè¯ä»£ç 
function verifyToken(token) {
  // ç¡¬ç¼–ç å…è®¸çš„ç®—æ³•ï¼Œæ°¸è¿œä¸è¦ä¿¡ä»» header ä¸­çš„ alg
  return jwt.verify(token, publicKey, {
    algorithms: ['RS256'],  // ç™½åå•
    issuer: 'https://auth.optima.shop',
    audience: 'https://api.optima.shop',
  });
}
```

#### é™·é˜± 2: å¯†é’¥æ··æ·†æ”»å‡»

```
åœºæ™¯: æœåŠ¡ç«¯ç”¨ RS256ï¼ˆéå¯¹ç§°ï¼‰ï¼Œæ”»å‡»è€…çŸ¥é“å…¬é’¥

æ”»å‡»:
  1. æ”»å‡»è€…æ‹¿åˆ°å…¬é’¥ï¼ˆå…¬é’¥æœ¬æ¥å°±æ˜¯å…¬å¼€çš„ï¼‰
  2. ç”¨å…¬é’¥ä½œä¸º HS256 çš„å¯†é’¥ç­¾åä¸€ä¸ªä¼ªé€  token
  3. è®¾ç½® header çš„ alg ä¸º HS256
  4. å¦‚æœæœåŠ¡ç«¯æ ¹æ® header é€‰æ‹©ç®—æ³•...
     å®ƒä¼šç”¨"å…¬é’¥"ä½œä¸º HMAC å¯†é’¥éªŒè¯ â†’ éªŒè¯é€šè¿‡ï¼

é˜²å¾¡: éªŒè¯æ—¶ç¡¬ç¼–ç ç®—æ³•ï¼Œä¸ä¿¡ä»» header
```

#### é™·é˜± 3: æœªéªŒè¯ç­¾å

```typescript
// âŒ å¸¸è§äºè°ƒè¯•ä»£ç æ®‹ç•™
const payload = JSON.parse(
  Buffer.from(token.split('.')[1], 'base64url').toString()
);
// åªè§£ç ï¼Œæ²¡éªŒè¯ç­¾å

// âŒ ä¹Ÿå¾ˆå±é™©ï¼šå…³é—­äº†ç­¾åéªŒè¯
jwt.decode(token);  // decode â‰  verify

// âœ… å§‹ç»ˆç”¨ verify
jwt.verify(token, publicKey, { algorithms: ['RS256'] });
```

#### é™·é˜± 4: ä¸æ£€æŸ¥ exp / iss / aud

```typescript
// âœ… å®Œæ•´çš„éªŒè¯
const payload = jwt.verify(token, publicKey, {
  algorithms: ['RS256'],
  issuer: 'https://auth.optima.shop',     // éªŒè¯ç­¾å‘è€…
  audience: 'https://api.optima.shop',     // éªŒè¯å—ä¼—
  clockTolerance: 30,                       // å…è®¸ 30 ç§’æ—¶é’Ÿåå·®
});

// è¿˜éœ€è¦æ£€æŸ¥ä¸šåŠ¡ç›¸å…³çš„ claims
if (payload.merchant_id !== requestedMerchantId) {
  throw new ForbiddenError('No access to this merchant');
}
```

---

## 4. Session vs Token è®¤è¯

### å¯¹æ¯”

```
Session è®¤è¯:
  å®¢æˆ·ç«¯ â”€â”€Cookie: sid=abc123â”€â”€> æœåŠ¡å™¨ â”€â”€æŸ¥ Redis/DBâ”€â”€> ç”¨æˆ·ä¿¡æ¯

Token è®¤è¯ (JWT):
  å®¢æˆ·ç«¯ â”€â”€Authorization: Bearer eyJ...â”€â”€> æœåŠ¡å™¨ â”€â”€æœ¬åœ°éªŒè¯â”€â”€> ç”¨æˆ·ä¿¡æ¯
```

| æ–¹é¢ | Session | JWT |
|------|---------|-----|
| å­˜å‚¨ | æœåŠ¡ç«¯ï¼ˆRedis/æ•°æ®åº“ï¼‰ | å®¢æˆ·ç«¯ï¼ˆLocalStorage/Cookieï¼‰ |
| æ‰©å±•æ€§ | éœ€è¦å…±äº« session store | æ— çŠ¶æ€ï¼Œå¤©ç„¶æ°´å¹³æ‰©å±• |
| åŠé”€ | åˆ é™¤ session å³å¯ | å›°éš¾ï¼ˆè§ä¸‹æ–‡ï¼‰ |
| è·¨åŸŸ | å—é™äº Cookie åŒæºç­–ç•¥ | Authorization header æ— æ­¤é™åˆ¶ |
| å¤§å° | Cookie å¾ˆå°ï¼ˆsession IDï¼‰ | JWT è¾ƒå¤§ï¼ˆpayload + ç­¾åï¼‰ |
| CSRF | Cookie è‡ªåŠ¨å‘é€ï¼Œéœ€é˜² CSRF | Header æ‰‹åŠ¨æºå¸¦ï¼Œå¤©ç„¶é˜² CSRF |
| XSS | HttpOnly Cookie å®‰å…¨ | LocalStorage æ˜“å— XSS æ”»å‡» |

### Token åŠé”€éš¾é¢˜

JWT æ˜¯æ— çŠ¶æ€çš„ï¼Œä¸€æ—¦ç­¾å‘ï¼Œåœ¨è¿‡æœŸå‰æ— æ³•è®©å®ƒ"å¤±æ•ˆ"ã€‚è¿™æ˜¯æœ€å¤§çš„æŒ‘æˆ˜ï¼š

```
åœºæ™¯: ç”¨æˆ·ä¿®æ”¹å¯†ç åï¼Œæ—§ token åº”è¯¥ç«‹å³å¤±æ•ˆ
     ç®¡ç†å‘˜ç¦ç”¨æŸä¸ªç”¨æˆ·ï¼Œå…¶ token åº”è¯¥ç«‹å³å¤±æ•ˆ
     æ£€æµ‹åˆ° token æ³„éœ²ï¼Œéœ€è¦ç´§æ€¥åŠé”€

æ–¹æ¡ˆå¯¹æ¯”:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–¹æ¡ˆ 1: çŸ­è¿‡æœŸæ—¶é—´ (æ¨èèµ·æ­¥æ–¹æ¡ˆ)                   â”‚
â”‚                                                   â”‚
â”‚ Access Token 15 åˆ†é’Ÿè¿‡æœŸ                           â”‚
â”‚ + Refresh Token è½®è½¬                              â”‚
â”‚                                                   â”‚
â”‚ ä¼˜ç‚¹: ç®€å•ï¼Œæ— é¢å¤–åŸºç¡€è®¾æ–½                           â”‚
â”‚ ç¼ºç‚¹: æœ€åæƒ…å†µä¸‹éœ€ç­‰ 15 åˆ†é’Ÿæ‰èƒ½"åŠé”€"              â”‚
â”‚ é€‚åˆ: Optima å½“å‰é˜¶æ®µ                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–¹æ¡ˆ 2: Token é»‘åå•                               â”‚
â”‚                                                   â”‚
â”‚ è¢«åŠé”€çš„ token ID (jti) å­˜å…¥ Redis                  â”‚
â”‚ æ¯æ¬¡éªŒè¯ token æ—¶æ£€æŸ¥é»‘åå•                          â”‚
â”‚                                                   â”‚
â”‚ ä¼˜ç‚¹: å¯ä»¥ç«‹å³åŠé”€                                  â”‚
â”‚ ç¼ºç‚¹: æ¯æ¬¡è¯·æ±‚éƒ½æŸ¥ Redisï¼ˆå¤±å»äº† JWT æ— çŠ¶æ€çš„ä¼˜åŠ¿ï¼‰    â”‚
â”‚ é€‚åˆ: å¯¹å®‰å…¨è¦æ±‚é«˜çš„åœºæ™¯                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–¹æ¡ˆ 3: Token ç‰ˆæœ¬å·                               â”‚
â”‚                                                   â”‚
â”‚ ç”¨æˆ·è¡¨åŠ  token_version å­—æ®µ                         â”‚
â”‚ JWT ä¸­åŒ…å«ç­¾å‘æ—¶çš„ç‰ˆæœ¬å·                             â”‚
â”‚ ä¿®æ”¹å¯†ç æ—¶ version++                               â”‚
â”‚ éªŒè¯æ—¶æ£€æŸ¥ version æ˜¯å¦åŒ¹é…                         â”‚
â”‚                                                   â”‚
â”‚ ä¼˜ç‚¹: å¯ä»¥åŠé”€æŸä¸ªç”¨æˆ·çš„æ‰€æœ‰ token                   â”‚
â”‚ ç¼ºç‚¹: æ¯æ¬¡è¯·æ±‚éœ€æŸ¥æ•°æ®åº“                             â”‚
â”‚ é€‚åˆ: "ä¿®æ”¹å¯†ç åç™»å‡ºæ‰€æœ‰è®¾å¤‡"åœºæ™¯                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ··åˆæ–¹æ¡ˆ

å®é™…é¡¹ç›®ä¸­ï¼Œå¾€å¾€ç»“åˆ Session å’Œ Tokenï¼š

```
Optima æ¨èæ–¹æ¡ˆ:

æµè§ˆå™¨ç«¯:
  - ç”¨ HttpOnly + Secure + SameSite Cookie å­˜å‚¨ session ID
  - æœåŠ¡ç«¯ç»´æŠ¤ sessionï¼ˆå¯åŠé”€ã€å¯è¿½è¸ªï¼‰
  - é˜² CSRF: SameSite=Strict æˆ– CSRF Token

API / ç§»åŠ¨ç«¯ / æœåŠ¡é—´:
  - ç”¨ JWTï¼ˆæ— çŠ¶æ€ã€è·¨åŸŸå‹å¥½ï¼‰
  - çŸ­è¿‡æœŸï¼ˆ15 åˆ†é’Ÿï¼‰+ Refresh Token è½®è½¬
  - å…³é”®æ“ä½œæ—¶æŸ¥é»‘åå•
```

---

## 5. é›¶ä¿¡ä»»æ¶æ„

### ä¼ ç»Ÿå®‰å…¨ vs é›¶ä¿¡ä»»

```
ä¼ ç»Ÿï¼ˆåŸå ¡ä¸æŠ¤åŸæ²³ï¼‰:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ é˜²ç«å¢™ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  å†…éƒ¨ç½‘ç»œ = å¯ä¿¡åŒºåŸŸ                      â”‚
  â”‚                                          â”‚
  â”‚  æœåŠ¡ A â”€â”€â”€â”€â”€â”€> æœåŠ¡ B â”€â”€â”€â”€â”€â”€> æ•°æ®åº“     â”‚
  â”‚       (æ— è®¤è¯)        (æ— è®¤è¯)             â”‚
  â”‚                                          â”‚
  â”‚  "åªè¦è¿›äº†é˜²ç«å¢™ï¼Œå°±æ˜¯è‡ªå·±äºº"               â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  é—®é¢˜: ä¸€æ—¦é˜²ç«å¢™è¢«çªç ´ï¼ˆVPN æ¼æ´ã€å†…é¬¼ã€è¢«å…¥ä¾µçš„å®¹å™¨ï¼‰ï¼Œ
        æ”»å‡»è€…å¯ä»¥è‡ªç”±æ¨ªå‘ç§»åŠ¨

é›¶ä¿¡ä»»:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                          â”‚
  â”‚  æœåŠ¡ A â”€â”€mTLSâ”€â”€> æœåŠ¡ B â”€â”€IAMâ”€â”€> æ•°æ®åº“  â”‚
  â”‚  (èº«ä»½éªŒè¯) (æœ€å°æƒé™)  (èº«ä»½éªŒè¯)(æœ€å°æƒé™) â”‚
  â”‚                                          â”‚
  â”‚  "æ¯ä¸€æ¬¡è®¿é—®éƒ½éœ€è¦éªŒè¯èº«ä»½å’Œæƒé™"            â”‚
  â”‚  "å³ä½¿åœ¨åŒä¸€ä¸ª VPC å†…ä¹Ÿä¸ä¾‹å¤–"              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é›¶ä¿¡ä»»åŸºæœ¬åŸåˆ™

1. **Never Trust, Always Verify** â€” ä¸å› ä¸ºè¯·æ±‚æ¥è‡ªå†…ç½‘å°±ä¿¡ä»»
2. **Least Privilege** â€” æ¯ä¸ªæœåŠ¡åªæœ‰å®Œæˆå·¥ä½œæ‰€éœ€çš„æœ€å°æƒé™
3. **Assume Breach** â€” å‡è®¾æ”»å‡»è€…å·²ç»åœ¨ç½‘ç»œå†…éƒ¨ï¼Œè®¾è®¡åº”å¯¹æ–¹æ¡ˆ
4. **Verify Explicitly** â€” åŸºäºæ‰€æœ‰å¯ç”¨ä¿¡æ¯ï¼ˆèº«ä»½ã€ä½ç½®ã€è®¾å¤‡ã€è¡Œä¸ºï¼‰åšè®¿é—®å†³ç­–
5. **Microsegmentation** â€” ç»†ç²’åº¦éš”ç¦»ï¼Œé™åˆ¶æ¨ªå‘ç§»åŠ¨

### BeyondCorp æ¨¡å‹ï¼ˆGoogle çš„é›¶ä¿¡ä»»å®è·µï¼‰

```
ä¼ ç»Ÿ VPN æ¨¡å¼:
  è¿œç¨‹å‘˜å·¥ â†’ VPN â†’ å…¬å¸å†…ç½‘ â†’ æ‰€æœ‰å†…éƒ¨æœåŠ¡
  é—®é¢˜: VPN æ˜¯å•ç‚¹çªç ´å£ï¼Œä¸€æ—¦ VPN å‡­è¯æ³„éœ²ï¼Œå…¨éƒ¨æš´éœ²

BeyondCorp:
  è¿œç¨‹å‘˜å·¥ â†’ Identity-Aware Proxy â†’ ç‰¹å®šæœåŠ¡
  â†‘ æ£€æŸ¥:
    - ç”¨æˆ·èº«ä»½ï¼ˆSSO/MFAï¼‰
    - è®¾å¤‡çŠ¶æ€ï¼ˆæ˜¯å¦åŠ å¯†ã€æ˜¯å¦æœ‰æœ€æ–°è¡¥ä¸ï¼‰
    - è®¿é—®ä¸Šä¸‹æ–‡ï¼ˆåœ°ç†ä½ç½®ã€æ—¶é—´ã€å†å²è¡Œä¸ºï¼‰
    - è¯·æ±‚æƒé™ï¼ˆåªå…è®¸è®¿é—®å·¥ä½œéœ€è¦çš„åº”ç”¨ï¼‰

å¯¹åº” AWS ç»„ä»¶:
  - AWS IAM Identity Center (SSO)
  - AWS Verified Access (Identity-Aware Proxy)
  - AWS Systems Manager (è®¾å¤‡ç®¡ç†)
```

### å¾®éš”ç¦»åœ¨ Optima çš„åº”ç”¨

```
å½“å‰çŠ¶æ€:
  å®‰å…¨ç»„çº§åˆ«çš„éš”ç¦»ï¼ˆç«¯å£çº§ï¼‰

  mcp-host â”€â”€(ä»»æ„ç«¯å£)â”€â”€> user-auth
  agentic-chat â”€â”€(ä»»æ„ç«¯å£)â”€â”€> commerce-backend

  é—®é¢˜: å®‰å…¨ç»„åªé™åˆ¶äº†ç«¯å£ï¼Œä¸é™åˆ¶"è°å¯ä»¥è°ƒä»€ä¹ˆ API"

è¿›é˜¶ (Service Mesh):
  mcp-host â”€â”€(åªå…è®¸ POST /api/verify)â”€â”€> user-auth
  agentic-chat â”€â”€(åªå…è®¸ GET /api/products)â”€â”€> commerce-backend

  é€šè¿‡ Service Mesh (Istio/AWS App Mesh) å®ç° L7 ç­–ç•¥
```

**å¯¹ Optima çš„åŠ¡å®å»ºè®®**:

| é˜¶æ®µ | æªæ–½ | å¤æ‚åº¦ | ä¼˜å…ˆçº§ |
|------|------|--------|--------|
| ç°åœ¨ | æœåŠ¡é—´è°ƒç”¨åŠ å…±äº« API Key | ä½ | â˜…â˜…â˜…â˜…â˜… |
| è¿‘æœŸ | æœåŠ¡é—´ç”¨ JWTï¼ˆClient Credentialsï¼‰ | ä¸­ | â˜…â˜…â˜…â˜… |
| æœªæ¥ | Service Mesh + mTLS | é«˜ | â˜…â˜… |

---

## 6. API å®‰å…¨å®è·µ

### Rate Limitingï¼ˆé€Ÿç‡é™åˆ¶ï¼‰

ä¸ºä»€ä¹ˆéœ€è¦ï¼šæ²¡æœ‰ Rate Limiting çš„ API å°±åƒæ²¡æœ‰é—¨é”çš„æˆ¿å­ã€‚

#### ä¸‰ç§å¸¸è§ç®—æ³•

```
1. å›ºå®šçª—å£ (Fixed Window)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ 1åˆ†é’Ÿå†…  â”‚â”‚ 1åˆ†é’Ÿå†…  â”‚â”‚ 1åˆ†é’Ÿå†…  â”‚
   â”‚ 100 æ¬¡  â”‚â”‚ 100 æ¬¡  â”‚â”‚ 100 æ¬¡  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   é—®é¢˜: çª—å£è¾¹ç•Œçªå‘
   åœ¨ç¬¬1ä¸ªçª—å£çš„æœ€å1ç§’å‘100æ¬¡ + ç¬¬2ä¸ªçª—å£çš„ç¬¬1ç§’å‘100æ¬¡
   = 2ç§’å†… 200 æ¬¡è¯·æ±‚

2. æ»‘åŠ¨çª—å£ (Sliding Window)
   â”€â”€â”€â”€â”€â”€[    1åˆ†é’Ÿæ»‘åŠ¨çª—å£    ]â”€â”€â”€â”€â”€â”€>
   éšæ—¶é—´æ»‘åŠ¨ï¼Œæ²¡æœ‰è¾¹ç•Œçªå‘é—®é¢˜
   å®ç°: Redis ZSETï¼ˆæˆå‘˜=è¯·æ±‚IDï¼Œåˆ†æ•°=æ—¶é—´æˆ³ï¼‰

3. ä»¤ç‰Œæ¡¶ (Token Bucket)          â† æ¨è

   æ¡¶å®¹é‡: 100 tokens
   è¡¥å……é€Ÿç‡: 10 tokens/ç§’

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹  â”‚ â† æ¯ä¸ªè¯·æ±‚æ¶ˆè€— 1 token
   â”‚  â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹  â”‚
   â”‚  â—‹â—‹â—‹â—‹â—‹â—‹     â”‚ â† æ¡¶ç©ºæ—¶æ‹’ç»è¯·æ±‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘
     10 tokens/ç§’ è¡¥å……

   å¥½å¤„: å…è®¸çªå‘ï¼ˆæ¡¶æ»¡æ—¶å¯ä»¥å¿«é€Ÿæ¶ˆè€—ï¼‰ï¼Œ
         ä½†å¹³å‡é€Ÿç‡è¢«é™åˆ¶

4. æ¼æ¡¶ (Leaky Bucket)

   è¯·æ±‚è¿›å…¥æ¡¶ â†’ æŒ‰å›ºå®šé€Ÿç‡æµå‡ºå¤„ç†

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  è¯·æ±‚ è¯·æ±‚    â”‚ â† çªå‘è¯·æ±‚å †ç§¯åœ¨æ¡¶é‡Œ
   â”‚  è¯·æ±‚ è¯·æ±‚    â”‚
   â”‚  è¯·æ±‚ è¯·æ±‚    â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
          â”‚ å›ºå®šé€Ÿç‡æµå‡º
          â–¼
      å¤„ç†è¯·æ±‚

   å¥½å¤„: è¾“å‡ºç»å¯¹å¹³æ»‘
   ç¼ºç‚¹: ä¸å…è®¸ä»»ä½•çªå‘
```

#### å®ç°ç¤ºä¾‹ï¼ˆRedis + Token Bucketï¼‰

```typescript
import Redis from 'ioredis';

const redis = new Redis();

interface RateLimitResult {
  allowed: boolean;
  remaining: number;
  retryAfter?: number;  // ç§’
}

async function checkRateLimit(
  key: string,           // å¦‚ "ratelimit:user:123" æˆ– "ratelimit:ip:1.2.3.4"
  maxTokens: number,     // æ¡¶å®¹é‡
  refillRate: number,    // æ¯ç§’è¡¥å…… token æ•°
): Promise<RateLimitResult> {
  const now = Date.now();
  const luaScript = `
    local key = KEYS[1]
    local max_tokens = tonumber(ARGV[1])
    local refill_rate = tonumber(ARGV[2])
    local now = tonumber(ARGV[3])

    local bucket = redis.call('hmget', key, 'tokens', 'last_refill')
    local tokens = tonumber(bucket[1]) or max_tokens
    local last_refill = tonumber(bucket[2]) or now

    -- è¡¥å…… tokens
    local elapsed = (now - last_refill) / 1000
    tokens = math.min(max_tokens, tokens + elapsed * refill_rate)

    if tokens >= 1 then
      tokens = tokens - 1
      redis.call('hmset', key, 'tokens', tokens, 'last_refill', now)
      redis.call('expire', key, math.ceil(max_tokens / refill_rate) + 1)
      return {1, math.floor(tokens)}
    else
      redis.call('hmset', key, 'tokens', tokens, 'last_refill', now)
      local retry_after = math.ceil((1 - tokens) / refill_rate)
      return {0, 0, retry_after}
    end
  `;

  const [allowed, remaining, retryAfter] = await redis.eval(
    luaScript, 1, key, maxTokens, refillRate, now
  ) as [number, number, number?];

  return {
    allowed: allowed === 1,
    remaining,
    retryAfter: retryAfter,
  };
}

// ä½¿ç”¨
const result = await checkRateLimit('ratelimit:user:123', 100, 10);
if (!result.allowed) {
  res.status(429).json({
    error: 'Too Many Requests',
    retryAfter: result.retryAfter,
  });
}

// è®¾ç½®æ ‡å‡† Rate Limit å“åº”å¤´
res.setHeader('X-RateLimit-Limit', 100);
res.setHeader('X-RateLimit-Remaining', result.remaining);
if (result.retryAfter) {
  res.setHeader('Retry-After', result.retryAfter);
}
```

### CORS è¯¦è§£

**ä»€ä¹ˆæ˜¯ CORS**: æµè§ˆå™¨çš„åŒæºç­–ç•¥é˜»æ­¢ç½‘é¡µå‘ä¸åŒåŸŸçš„ API å‘è¯·æ±‚ã€‚CORS (Cross-Origin Resource Sharing) æ˜¯"æ”¾è¡Œåå•"æœºåˆ¶ã€‚

```
æµè§ˆå™¨å‘è·¨åŸŸè¯·æ±‚æ—¶çš„æµç¨‹:

1. ç®€å•è¯·æ±‚ (GET/POST with ç®€å• Content-Type):
   æµè§ˆå™¨ â”€â”€GET /api/productsâ”€â”€> æœåŠ¡å™¨
   æµè§ˆå™¨ <â”€â”€Access-Control-Allow-Origin: https://store.optima.shopâ”€â”€
   æµè§ˆå™¨: "å…è®¸ï¼Œæ”¾è¡Œ"

2. é¢„æ£€è¯·æ±‚ (PUT/DELETE/è‡ªå®šä¹‰ Header):
   æµè§ˆå™¨ â”€â”€OPTIONS /api/productsâ”€â”€> æœåŠ¡å™¨   (é¢„æ£€)
   æµè§ˆå™¨ <â”€â”€Allow-Origin + Allow-Methods + Allow-Headersâ”€â”€
   æµè§ˆå™¨: "é¢„æ£€é€šè¿‡"
   æµè§ˆå™¨ â”€â”€PUT /api/productsâ”€â”€> æœåŠ¡å™¨       (çœŸæ­£è¯·æ±‚)
```

```typescript
// Express CORS é…ç½®
import cors from 'cors';

app.use(cors({
  // âœ… ç™½åå•æŒ‡å®šå…è®¸çš„æº
  origin: [
    'https://store.optima.shop',
    'https://admin.optima.shop',
    'https://agent-web.optima.shop',
  ],

  // âœ… å…è®¸æºå¸¦ Cookie
  credentials: true,

  // âœ… å…è®¸çš„æ–¹æ³•
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH'],

  // âœ… å…è®¸çš„è‡ªå®šä¹‰ Header
  allowedHeaders: ['Content-Type', 'Authorization', 'X-Request-ID'],

  // âœ… é¢„æ£€ç¼“å­˜æ—¶é—´ï¼ˆå‡å°‘ OPTIONS è¯·æ±‚ï¼‰
  maxAge: 86400,  // 24 å°æ—¶
}));

// âŒ æ°¸è¿œä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒè¿™æ ·åš
app.use(cors({ origin: '*', credentials: true }));
// origin: '*' + credentials: true æµè§ˆå™¨ç›´æ¥æ‹’ç»
// origin: '*' å…è®¸ä»»ä½•ç½‘ç«™è¯»å–ä½ çš„ API å“åº”
```

### CSP (Content Security Policy)

CSP å¤´å‘Šè¯‰æµè§ˆå™¨ï¼šåªå…è®¸ä»æŒ‡å®šæ¥æºåŠ è½½èµ„æºï¼Œé˜²æ­¢ XSS æ”»å‡»ã€‚

```typescript
// Express ä¸­è®¾ç½® CSP
app.use((req, res, next) => {
  res.setHeader('Content-Security-Policy', [
    "default-src 'self'",                      // é»˜è®¤åªå…è®¸åŒæº
    "script-src 'self' 'nonce-abc123'",        // JS åªå…è®¸åŒæº + å¸¦ nonce çš„å†…è”
    "style-src 'self' 'unsafe-inline'",        // CSS å…è®¸å†…è”ï¼ˆæ¡†æ¶å¸¸éœ€è¦ï¼‰
    "img-src 'self' https://cdn.optima.shop",  // å›¾ç‰‡å…è®¸ CDN
    "connect-src 'self' https://api.optima.shop wss://ai.optima.shop", // API + WS
    "frame-ancestors 'none'",                   // ç¦æ­¢è¢« iframe åµŒå…¥ï¼ˆé˜² clickjackingï¼‰
  ].join('; '));
  next();
});
```

### OWASP API Security Top 10 (2023)

| # | é£é™© | è¯´æ˜ | Optima ç›¸å…³æ€§ |
|---|------|------|-------------|
| API1 | **Broken Object Level Authorization** | ç”¨æˆ· A å¯ä»¥è®¿é—®ç”¨æˆ· B çš„èµ„æº | âš ï¸ æ£€æŸ¥æ¯ä¸ª API æ˜¯å¦éªŒè¯èµ„æºå½’å± |
| API2 | **Broken Authentication** | è®¤è¯æœºåˆ¶ç¼ºé™· | âš ï¸ JWT å®ç°æ˜¯å¦å®‰å…¨ |
| API3 | **Broken Object Property Level Authorization** | è¿”å›äº†ç”¨æˆ·ä¸è¯¥çœ‹åˆ°çš„å­—æ®µ | âš ï¸ API å“åº”æ˜¯å¦è¿‡æ»¤äº†æ•æ„Ÿå­—æ®µ |
| API4 | **Unrestricted Resource Consumption** | æ—  Rate Limiting | âŒ å½“å‰æ²¡æœ‰ Rate Limiting |
| API5 | **Broken Function Level Authorization** | æ™®é€šç”¨æˆ·è®¿é—®ç®¡ç†å‘˜æ¥å£ | âš ï¸ è§’è‰²æ£€æŸ¥æ˜¯å¦å®Œå–„ |
| API6 | **Unrestricted Access to Sensitive Business Flows** | å…³é”®ä¸šåŠ¡æµç¨‹ï¼ˆå¦‚ä¸‹å•ï¼‰å¯è¢«è‡ªåŠ¨åŒ–æ»¥ç”¨ | âš ï¸ |
| API7 | **Server Side Request Forgery (SSRF)** | æœåŠ¡ç«¯è¢«è¯±å¯¼è¯·æ±‚å†…éƒ¨èµ„æº | âš ï¸ fetch-mcp éœ€ç‰¹åˆ«æ³¨æ„ |
| API8 | **Security Misconfiguration** | ä¸å®‰å…¨çš„é»˜è®¤é…ç½® | âš ï¸ CORSã€Headers |
| API9 | **Improper Inventory Management** | æ—§ç‰ˆ/æµ‹è¯• API æœªä¸‹çº¿ | æ£€æŸ¥æ˜¯å¦æœ‰åºŸå¼ƒç«¯ç‚¹ |
| API10 | **Unsafe Consumption of APIs** | ç›²ç›®ä¿¡ä»»ç¬¬ä¸‰æ–¹ API è¿”å›çš„æ•°æ® | âš ï¸ MCP å·¥å…·è°ƒç”¨å¤–éƒ¨ API |

**å¯¹ Optima æœ€å…³é”®çš„**:
- **API1 (BOLA)**: æ£€æŸ¥ commerce-backend çš„æ¯ä¸ªç«¯ç‚¹â€”â€”ç”¨æˆ· A èƒ½å¦é€šè¿‡æ”¹ ID è®¿é—®ç”¨æˆ· B çš„è®¢å•ï¼Ÿ
- **API4 (Rate Limiting)**: å¿…é¡»åŠ ï¼Œå°¤å…¶æ˜¯ AI ç›¸å…³çš„é«˜æˆæœ¬ç«¯ç‚¹
- **API7 (SSRF)**: fetch-mcp æ˜¯ SSRF é«˜é£é™©ç»„ä»¶ï¼Œéœ€è¦ URL ç™½åå•/é»‘åå•

---

## 7. å¯†é’¥ç®¡ç†

### å·¥å…·å¯¹æ¯”

| ç‰¹æ€§ | Infisical | HashiCorp Vault | AWS Secrets Manager |
|------|-----------|-----------------|-------------------|
| éƒ¨ç½²æ–¹å¼ | è‡ªæ‰˜ç®¡/SaaS | è‡ªæ‰˜ç®¡/HCP | å…¨æ‰˜ç®¡ |
| æˆæœ¬ | å¼€æºå…è´¹ | å¼€æºå…è´¹/ä¼ä¸šç‰ˆä»˜è´¹ | $0.40/secret/æœˆ |
| å¤æ‚åº¦ | â˜…â˜… | â˜…â˜…â˜…â˜…â˜… | â˜… |
| UI | â˜…â˜…â˜…â˜…â˜…ï¼ˆç°ä»£åŒ–ï¼‰ | â˜…â˜…â˜… | â˜…â˜…â˜… |
| åŠ¨æ€å¯†é’¥ | æœ‰é™ | â˜…â˜…â˜…â˜…â˜…ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰ | æ”¯æŒ Lambda è½®è½¬ |
| Secret Referencing | âœ… | âœ… | âŒ |
| CI/CD é›†æˆ | GitHub Actions, etc | å…¨å¹³å° | AWS åŸç”Ÿ |
| å®¡è®¡æ—¥å¿— | âœ… | â˜…â˜…â˜…â˜…â˜…ï¼ˆè¯¦å°½ï¼‰ | âœ… |
| é€‚åˆåœºæ™¯ | ä¸­å°å›¢é˜Ÿ | å¤§å‹ä¼ä¸š/å¤šäº‘ | çº¯ AWS ç¯å¢ƒ |

**Optima å½“å‰é€‰æ‹©**: Infisical è‡ªæ‰˜ç®¡ï¼ˆhttps://secrets.optima.shop:5080ï¼‰

```
ä¸ºä»€ä¹ˆé€‰ Infisical:
  âœ… å¼€æºå…è´¹ï¼ŒUI å‹å¥½
  âœ… Secret Referencingï¼ˆè·¨æ–‡ä»¶å¤¹å¼•ç”¨åŒä¸€ä¸ªå¯†é’¥ï¼‰
  âœ… Machine Identityï¼ˆCI/CD é›†æˆï¼‰
  âœ… ç¯å¢ƒéš”ç¦»ï¼ˆprod/staging/developmentï¼‰
  âœ… ç‰ˆæœ¬æ§åˆ¶å’Œå®¡è®¡æ—¥å¿—

  vs HashiCorp Vault: Vault å¤ªå¤æ‚äº†ï¼Œéœ€è¦ä¸“äººè¿ç»´ï¼Œä¸é€‚åˆå°å›¢é˜Ÿ
  vs AWS Secrets Manager: æŒ‰ secret æ”¶è´¹ï¼Œsecret å¤šäº†æˆæœ¬é«˜
```

### å¯†é’¥è½®è½¬

```
å¯†é’¥è½®è½¬æµç¨‹:

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ æ—§å¯†é’¥   â”‚     â”‚ æ–°å¯†é’¥    â”‚     â”‚ æ—§å¯†é’¥    â”‚
  â”‚ (æ´»è·ƒ)   â”‚ â†’   â”‚ (æ´»è·ƒ)   â”‚ â†’   â”‚ (åˆ é™¤)   â”‚
  â”‚          â”‚     â”‚ æ—§å¯†é’¥    â”‚     â”‚ æ–°å¯†é’¥    â”‚
  â”‚          â”‚     â”‚ (è¿‡æ¸¡æœŸ)  â”‚     â”‚ (æ´»è·ƒ)   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    æ­£å¸¸è¿è¡Œ          è½®è½¬ä¸­           è½®è½¬å®Œæˆ

å…³é”®: è½®è½¬æœŸé—´æ–°æ—§å¯†é’¥å…±å­˜ï¼Œé¿å…ä¸­æ–­

æ•°æ®åº“å¯†ç è½®è½¬ç¤ºä¾‹:
  1. Infisical ç”Ÿæˆæ–°å¯†ç 
  2. PostgreSQL ALTER ROLE SET PASSWORDï¼ˆæ–°å¯†ç ç”Ÿæ•ˆï¼Œæ—§å¯†ç ä»æœ‰æ•ˆï¼Ÿä¸ï¼ŒPG ç«‹å³å¤±æ•ˆï¼‰

  æ›´å®‰å…¨çš„æ–¹å¼:
  1. åˆ›å»ºæ–°çš„æ•°æ®åº“è§’è‰²ï¼ˆauth_user_v2ï¼‰
  2. èµ‹äºˆä¸ auth_user ç›¸åŒçš„æƒé™
  3. æœåŠ¡é…ç½®æ›´æ–°ä¸º auth_user_v2
  4. æ»šåŠ¨é‡å¯æœåŠ¡
  5. ç¡®è®¤æ‰€æœ‰è¿æ¥åˆ‡æ¢ååˆ é™¤ auth_user
```

### æœ€å°æƒé™åŸåˆ™

```
âŒ å½“å‰ï¼ˆå¯èƒ½çš„é—®é¢˜ï¼‰:
  æ‰€æœ‰æœåŠ¡å…±ç”¨ä¸€ä¸ª Infisical Machine Identity
  æ‰€æœ‰æœåŠ¡éƒ½èƒ½è¯»å–æ‰€æœ‰å¯†é’¥

âœ… æœ€ä½³å®è·µ:
  æ¯ä¸ªæœåŠ¡ä¸€ä¸ª Machine Identity
  æ¯ä¸ª Identity åªèƒ½è¯»å–è‡ªå·±æ–‡ä»¶å¤¹ä¸‹çš„å¯†é’¥

Infisical æ–‡ä»¶å¤¹ç»“æ„:
  /prod
    /user-auth       â† user-auth MI åªèƒ½è®¿é—®è¿™é‡Œ
      DATABASE_URL
      JWT_SECRET
      OAUTH_CLIENT_SECRET
    /commerce-backend â† commerce-backend MI åªèƒ½è®¿é—®è¿™é‡Œ
      DATABASE_URL
      STRIPE_SECRET_KEY
    /shared           â† æ‰€æœ‰æœåŠ¡å¯è¯»
      REDIS_URL
      INFISICAL_SITE_URL
```

---

## 8. mTLSï¼ˆåŒå‘ TLS è®¤è¯ï¼‰

### å•å‘ TLS vs åŒå‘ TLS

```
å•å‘ TLSï¼ˆä½ ç°åœ¨ç”¨çš„ï¼ŒHTTPSï¼‰:
  å®¢æˆ·ç«¯éªŒè¯æœåŠ¡å™¨èº«ä»½

  æµè§ˆå™¨ â”€â”€"ä½ æ˜¯è°ï¼Ÿ"â”€â”€> ALB
  æµè§ˆå™¨ <â”€â”€"æˆ‘æ˜¯ *.optima.shopï¼Œè¿™æ˜¯æˆ‘çš„è¯ä¹¦"â”€â”€
  æµè§ˆå™¨: "ACM ç­¾å‘çš„ï¼Œå¯ä¿¡" âœ…
  æµè§ˆå™¨ â”€â”€åŠ å¯†é€šä¿¡â”€â”€> ALB

åŒå‘ TLSï¼ˆmTLSï¼‰:
  å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨äº’ç›¸éªŒè¯èº«ä»½

  æœåŠ¡ A â”€â”€"ä½ æ˜¯è°ï¼Ÿ"â”€â”€> æœåŠ¡ B
  æœåŠ¡ A <â”€â”€"æˆ‘æ˜¯ service-bï¼Œè¿™æ˜¯æˆ‘çš„è¯ä¹¦"â”€â”€
  æœåŠ¡ A: "å¯ä¿¡" âœ…
  æœåŠ¡ B â”€â”€"ä½ æ˜¯è°ï¼Ÿ"â”€â”€> æœåŠ¡ A
  æœåŠ¡ B <â”€â”€"æˆ‘æ˜¯ service-aï¼Œè¿™æ˜¯æˆ‘çš„è¯ä¹¦"â”€â”€
  æœåŠ¡ B: "å¯ä¿¡" âœ…
  åŒå‘åŠ å¯†é€šä¿¡ ğŸ”’
```

### ä¸ºä»€ä¹ˆ mTLS é‡è¦

```
åœºæ™¯: mcp-host è°ƒç”¨ user-auth éªŒè¯ token

æ²¡æœ‰ mTLS:
  æ”»å‡»è€…å…¥ä¾µäº†ä¸€ä¸ªå®¹å™¨
  â†’ ç”¨è¯¥å®¹å™¨ç›´æ¥è°ƒç”¨ user-auth çš„ /internal/verify
  â†’ user-auth æ— æ³•åŒºåˆ†"æ­£å¸¸çš„ mcp-host è¯·æ±‚"å’Œ"è¢«å…¥ä¾µå®¹å™¨çš„è¯·æ±‚"

æœ‰ mTLS:
  æ”»å‡»è€…å…¥ä¾µäº†ä¸€ä¸ªå®¹å™¨
  â†’ è¯¥å®¹å™¨æ²¡æœ‰ mcp-host çš„å®¢æˆ·ç«¯è¯ä¹¦
  â†’ TLS æ¡æ‰‹å¤±è´¥ï¼Œæ— æ³•å»ºç«‹è¿æ¥
  â†’ user-auth æ‹’ç»æ‰€æœ‰æ²¡æœ‰æœ‰æ•ˆå®¢æˆ·ç«¯è¯ä¹¦çš„è¯·æ±‚
```

### è¯ä¹¦ç®¡ç†

mTLS æœ€å¤§çš„æŒ‘æˆ˜ä¸æ˜¯å®ç°ï¼Œè€Œæ˜¯**è¯ä¹¦ç®¡ç†**ï¼š

```
éœ€è¦ç®¡ç†çš„:
  - CA è¯ä¹¦ï¼ˆæ ¹è¯ä¹¦ã€ä¸­é—´è¯ä¹¦ï¼‰
  - æ¯ä¸ªæœåŠ¡çš„å®¢æˆ·ç«¯/æœåŠ¡å™¨è¯ä¹¦
  - è¯ä¹¦æœ‰æ•ˆæœŸå’Œè½®è½¬
  - è¯ä¹¦åŠé”€åˆ—è¡¨ (CRL)

æ‰‹åŠ¨ç®¡ç†: å™©æ¢¦ï¼ˆ10 ä¸ªæœåŠ¡ = 20+ è¯ä¹¦ï¼‰

è‡ªåŠ¨åŒ–æ–¹æ¡ˆ:

1. Service Meshï¼ˆæ¨èï¼‰
   Istio/Linkerd è‡ªåŠ¨ä¸ºæ¯ä¸ª Pod ç­¾å‘å’Œè½®è½¬è¯ä¹¦
   åº”ç”¨ä»£ç é›¶æ”¹åŠ¨

   Service A â†’ Sidecar Proxy â”€â”€mTLSâ”€â”€> Sidecar Proxy â†’ Service B

2. AWS Private CA + ACM
   AWS æ‰˜ç®¡çš„ CAï¼Œè‡ªåŠ¨ç­¾å‘å’Œè½®è½¬
   æˆæœ¬: $400/æœˆï¼ˆCAï¼‰+ $0.75/è¯ä¹¦

3. cert-manager (Kubernetes)
   å¼€æºæ–¹æ¡ˆï¼Œè‡ªåŠ¨ç­¾å‘ Let's Encrypt æˆ–è‡ªç­¾è¯ä¹¦
   ä»…é€‚ç”¨äº Kubernetes ç¯å¢ƒ

4. SPIFFE/SPIRE
   äº‘åŸç”Ÿèº«ä»½æ¡†æ¶ï¼Œè‡ªåŠ¨ç­¾å‘çŸ­æœŸè¯ä¹¦
   ä¸ä¾èµ– Kubernetesï¼ŒECS ä¹Ÿå¯ä»¥ç”¨
```

### åœ¨ Service Mesh ä¸­çš„åº”ç”¨

```
Istio mTLS ç¤ºä¾‹:

1. å®‰è£… Istio â†’ è‡ªåŠ¨æ³¨å…¥ sidecar proxy

2. é…ç½® PeerAuthenticationï¼ˆå…¨å±€ mTLSï¼‰:

apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: istio-system
spec:
  mtls:
    mode: STRICT    # æ‰€æœ‰æœåŠ¡é—´é€šä¿¡å¿…é¡» mTLS

3. é…ç½® AuthorizationPolicyï¼ˆL7 è®¿é—®æ§åˆ¶ï¼‰:

apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: user-auth-policy
spec:
  selector:
    matchLabels:
      app: user-auth
  rules:
  - from:
    - source:
        principals: ["cluster.local/ns/default/sa/mcp-host"]
    to:
    - operation:
        methods: ["POST"]
        paths: ["/api/verify", "/api/introspect"]
  - from:
    - source:
        principals: ["cluster.local/ns/default/sa/agentic-chat"]
    to:
    - operation:
        methods: ["GET"]
        paths: ["/api/users/*"]
```

**å¯¹ Optima çš„åŠ¡å®å»ºè®®**: ç›®å‰åœ¨ ECS ä¸Šå®ç° mTLS æˆæœ¬è¾ƒé«˜ã€‚åŠ¡å®çš„æ›¿ä»£æ–¹æ¡ˆï¼š
1. **è¿‘æœŸ**: æœåŠ¡é—´è°ƒç”¨åŠ  API Key/JWT éªŒè¯ï¼ˆå†…éƒ¨å…±äº«å¯†é’¥å­˜ Infisicalï¼‰
2. **ä¸­æœŸ**: å¦‚æœè¿ç§»åˆ° Kubernetesï¼Œç”¨ Istio è‡ªåŠ¨ mTLS
3. **é•¿æœŸ**: å¦‚æœç•™åœ¨ ECSï¼Œè€ƒè™‘ AWS App Mesh + SPIRE

---

## æ•´ä½“å®‰å…¨æ¶æ„æ€»è§ˆ

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                   äº’è”ç½‘                             â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  WAF (Web Application Firewall)                     â”‚
                    â”‚  - SQL æ³¨å…¥è¿‡æ»¤                                      â”‚
                    â”‚  - XSS è¿‡æ»¤                                         â”‚
                    â”‚  - Rate Limiting (IP çº§)                            â”‚
                    â”‚  - åœ°ç†ä½ç½®å°ç¦                                      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  ALB (Application Load Balancer)                    â”‚
                    â”‚  - HTTPS ç»ˆæ­¢ (ACM è¯ä¹¦)                            â”‚
                    â”‚  - è·¯ç”±è§„åˆ™ (æŒ‰åŸŸåè½¬å‘)                              â”‚
                    â”‚  - å¥åº·æ£€æŸ¥                                          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚          â”‚          â”‚          â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ–¼â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ user-auth    â”‚  â”‚ commerce   â”‚  â”‚ mcp-hostâ”‚ â”‚agentic-chatâ”‚
              â”‚              â”‚  â”‚ -backend   â”‚  â”‚         â”‚ â”‚            â”‚
              â”‚ JWT ç­¾å‘/éªŒè¯ â”‚  â”‚ BOLA æ£€æŸ¥   â”‚  â”‚ SSRF é˜²æŠ¤â”‚ â”‚ AI å®‰å…¨    â”‚
              â”‚ OAuth 2.0   â”‚  â”‚ è¾“å…¥æ ¡éªŒ    â”‚  â”‚ URLç™½åå•â”‚ â”‚ Promptæ³¨å…¥ â”‚
              â”‚ Refresh Tokenâ”‚  â”‚ Rate Limit â”‚  â”‚         â”‚ â”‚ è¾“å‡ºè¿‡æ»¤   â”‚
              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Infisical    â”‚
              â”‚  å¯†é’¥ç®¡ç†      â”‚
              â”‚  å®¡è®¡æ—¥å¿—      â”‚
              â”‚  è‡ªåŠ¨è½®è½¬ (TODO)â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ¨èå­¦ä¹ èµ„æ–™

### OAuth 2.0 & OIDC

| èµ„æº | ç±»å‹ | æ—¶é—´ | è¯´æ˜ |
|------|------|------|------|
| [RFC 6749 - OAuth 2.0](https://datatracker.ietf.org/doc/html/rfc6749) | è§„èŒƒ | 2h | OAuth 2.0 æ ¸å¿ƒè§„èŒƒï¼Œè‡³å°‘è¯»ä¸€é |
| [RFC 7636 - PKCE](https://datatracker.ietf.org/doc/html/rfc7636) | è§„èŒƒ | 30min | PKCE æ‰©å±•ï¼ŒSPA/ç§»åŠ¨ç«¯å¿…è¯» |
| [RFC 7662 - Token Introspection](https://datatracker.ietf.org/doc/html/rfc7662) | è§„èŒƒ | 30min | Token å®æ—¶éªŒè¯æ¥å£ |
| [OAuth 2.0 Simplified (oauth.com)](https://www.oauth.com/) | æ•™ç¨‹ | 3h | Aaron Parecki å†™çš„å®æˆ˜æŒ‡å—ï¼Œæ¯” RFC å¥½è¯» |
| [OpenID Connect Core](https://openid.net/specs/openid-connect-core-1_0.html) | è§„èŒƒ | 2h | OIDC æ ¸å¿ƒè§„èŒƒ |

### JWT & è®¤è¯å®‰å…¨

| èµ„æº | ç±»å‹ | æ—¶é—´ | è¯´æ˜ |
|------|------|------|------|
| [JWT.io](https://jwt.io/) | å·¥å…· | éšæ—¶ | JWT è°ƒè¯•å·¥å…·ï¼Œå¯ä»¥è§£ç å’ŒéªŒè¯ token |
| [RFC 7519 - JWT](https://datatracker.ietf.org/doc/html/rfc7519) | è§„èŒƒ | 1h | JWT æ ¸å¿ƒè§„èŒƒ |
| [Critical vulnerabilities in JSON Web Token libraries](https://auth0.com/blog/critical-vulnerabilities-in-json-web-token-libraries/) | åšå®¢ | 30min | JWT åº“çš„å¸¸è§æ¼æ´ï¼Œå¿…è¯» |
| [Hacking JWT Tokens (Hacker101)](https://www.youtube.com/watch?v=d6UmR0d6OjI) | è§†é¢‘ | 30min | JWT æ”»å‡»æ‰‹æ³•æ¼”ç¤º |

### API å®‰å…¨

| èµ„æº | ç±»å‹ | æ—¶é—´ | è¯´æ˜ |
|------|------|------|------|
| [OWASP API Security Top 10](https://owasp.org/API-Security/) | æ–‡æ¡£ | 2h | API å®‰å…¨çš„æƒå¨å‚è€ƒ |
| [OWASP Top 10 for LLM Applications](https://owasp.org/www-project-top-10-for-large-language-model-applications/) | æ–‡æ¡£ | 1h | AI åº”ç”¨ç‰¹æœ‰çš„å®‰å…¨å¨èƒ |
| [API Security in Action](https://www.manning.com/books/api-security-in-action) | ä¹¦ | 20h | ä»é›¶åˆ°ç²¾é€š API å®‰å…¨çš„æœ€ä½³ä¹¦ç± |

### é›¶ä¿¡ä»» & ç½‘ç»œå®‰å…¨

| èµ„æº | ç±»å‹ | æ—¶é—´ | è¯´æ˜ |
|------|------|------|------|
| [BeyondCorp (Google)](https://cloud.google.com/beyondcorp) | è®ºæ–‡/æ–‡æ¡£ | 2h | Google é›¶ä¿¡ä»»æ¶æ„çš„åŸå§‹è®ºæ–‡ |
| [NIST SP 800-207 Zero Trust Architecture](https://csrc.nist.gov/publications/detail/sp/800-207/final) | è§„èŒƒ | 3h | é›¶ä¿¡ä»»æ¶æ„çš„å®˜æ–¹å®šä¹‰ |
| [AWS Well-Architected Security Pillar](https://docs.aws.amazon.com/wellarchitected/latest/security-pillar/) | æ–‡æ¡£ | æŒ‰éœ€ | AWS å®‰å…¨æ¶æ„çš„å®Œæ•´æ¡†æ¶ |

### å¯†é’¥ç®¡ç†

| èµ„æº | ç±»å‹ | æ—¶é—´ | è¯´æ˜ |
|------|------|------|------|
| [Infisical Docs](https://infisical.com/docs) | æ–‡æ¡£ | 1h | æˆ‘ä»¬æ­£åœ¨ä½¿ç”¨çš„å·¥å…· |
| [HashiCorp Vault Tutorials](https://developer.hashicorp.com/vault/tutorials) | æ•™ç¨‹ | æŒ‰éœ€ | äº†è§£è¡Œä¸šæ ‡å‡†å¯†é’¥ç®¡ç† |
| [OWASP Secrets Management Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html) | æ–‡æ¡£ | 1h | å¯†é’¥ç®¡ç†æœ€ä½³å®è·µæ¸…å• |

### å®è·µå»ºè®®

**å­¦ä¹ è·¯å¾„å»ºè®®**:

```
Week 1: OAuth 2.0 + OIDC
  - è¯» oauth.com å…¥é—¨
  - ç”¨ jwt.io æ‰‹åŠ¨è§£ç  token
  - åœ¨ user-auth ä»£ç ä¸­è¿½è¸ª token ç­¾å‘å’ŒéªŒè¯æµç¨‹

Week 2: JWT å®‰å…¨ + è®¤è¯æ”»é˜²
  - è¯» Auth0 çš„ JWT æ¼æ´åšå®¢
  - ç”¨ Burp Suite / OWASP ZAP æµ‹è¯•è‡ªå·±çš„ API
  - æ£€æŸ¥ user-auth çš„ JWT éªŒè¯æ˜¯å¦æœ‰ä¸Šè¿°é™·é˜±

Week 3: API å®‰å…¨ + Rate Limiting
  - é€šè¯» OWASP API Security Top 10
  - å¯¹ç…§æ£€æŸ¥ commerce-backend çš„æ¯ä¸ªç«¯ç‚¹
  - å®ç° Rate Limiting åŸå‹

Week 4: é›¶ä¿¡ä»» + å¯†é’¥ç®¡ç†
  - è¯» BeyondCorp è®ºæ–‡
  - å®¡è®¡ Infisical çš„æƒé™é…ç½®
  - ä¸ºæœåŠ¡é—´è°ƒç”¨è®¾è®¡è®¤è¯æ–¹æ¡ˆ
```
